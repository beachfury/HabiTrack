import { useState, useEffect } from 'react';
import {
  FileText,
  FolderPlus,
  Pencil,
  Trash2,
  Plus,
  X,
  Check,
  ChevronDown,
  ChevronUp,
  Loader2,
} from 'lucide-react';
import { api, type ChoreTemplate, type ChoreCategory } from '../src/lib/api.ts.bak';

interface ManageViewProps {
  categories: ChoreCategory[];
  onSuccess: (msg: string) => void;
  onError: (msg: string) => void;
  onAddChore: () => void;
  onAddCategory: () => void;
}

type ManageTab = 'templates' | 'categories';

const DIFFICULTY_COLORS: Record<string, string> = {
  easy: 'bg-green-100 text-green-700',
  medium: 'bg-yellow-100 text-yellow-700',
  hard: 'bg-red-100 text-red-700',
};

export function ManageView({
  categories,
  onSuccess,
  onError,
  onAddChore,
  onAddCategory,
}: ManageViewProps) {
  const [activeTab, setActiveTab] = useState<ManageTab>('templates');
  const [templates, setTemplates] = useState<ChoreTemplate[]>([]);
  const [loading, setLoading] = useState(true);
  const [expandedCategories, setExpandedCategories] = useState<Set<number | null>>(new Set());
  const [editingTemplate, setEditingTemplate] = useState<ChoreTemplate | null>(null);
  const [editingCategory, setEditingCategory] = useState<ChoreCategory | null>(null);
  const [deleteConfirm, setDeleteConfirm] = useState<{
    type: 'template' | 'category';
    id: number;
  } | null>(null);

  useEffect(() => {
    fetchTemplates();
  }, []);

  const fetchTemplates = async () => {
    try {
      setLoading(true);
      const data = await api.getChoreTemplates();
      setTemplates(data.templates);
      // Auto-expand all categories
      const catIds = new Set(data.templates.map((t) => t.categoryId));
      setExpandedCategories(catIds);
    } catch (err) {
      onError('Failed to load templates');
    } finally {
      setLoading(false);
    }
  };

  const toggleCategory = (categoryId: number | null) => {
    setExpandedCategories((prev) => {
      const next = new Set(prev);
      if (next.has(categoryId)) {
        next.delete(categoryId);
      } else {
        next.add(categoryId);
      }
      return next;
    });
  };

  // Group templates by category
  const templatesByCategory = categories.reduce(
    (acc, cat) => {
      acc[cat.id] = templates.filter((t) => t.categoryId === cat.id);
      return acc;
    },
    {} as Record<number, ChoreTemplate[]>,
  );

  const uncategorizedTemplates = templates.filter((t) => !t.categoryId);

  const handleDeleteTemplate = async (templateId: number) => {
    try {
      await api.deleteChoreTemplate(templateId);
      setTemplates((prev) => prev.filter((t) => t.id !== templateId));
      onSuccess('Template deleted');
      setDeleteConfirm(null);
    } catch (err) {
      onError('Failed to delete template');
    }
  };

  const handleDeleteCategory = async (categoryId: number) => {
    try {
      await api.deleteChoreCategory(categoryId);
      onSuccess('Category deleted');
      setDeleteConfirm(null);
      // Refresh to update UI
      window.location.reload();
    } catch (err) {
      onError('Failed to delete category');
    }
  };

  const handleUpdateTemplate = async (templateId: number, updates: Partial<ChoreTemplate>) => {
    try {
      const result = await api.updateChoreTemplate(templateId, updates);
      setTemplates((prev) =>
        prev.map((t) => (t.id === templateId ? { ...t, ...result.template } : t)),
      );
      onSuccess('Template updated');
      setEditingTemplate(null);
    } catch (err) {
      onError('Failed to update template');
    }
  };

  const handleUpdateCategory = async (categoryId: number, updates: Partial<ChoreCategory>) => {
    try {
      await api.updateChoreCategory(categoryId, updates);
      onSuccess('Category updated');
      setEditingCategory(null);
      window.location.reload();
    } catch (err) {
      onError('Failed to update category');
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="animate-spin text-purple-500" size={32} />
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* Tab Buttons */}
      <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
        <button
          onClick={() => setActiveTab('templates')}
          className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
            activeTab === 'templates'
              ? 'bg-white text-purple-700 shadow-sm'
              : 'text-gray-600 hover:text-gray-900'
          }`}
        >
          <FileText size={16} className="inline mr-2" />
          Templates
        </button>
        <button
          onClick={() => setActiveTab('categories')}
          className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
            activeTab === 'categories'
              ? 'bg-white text-purple-700 shadow-sm'
              : 'text-gray-600 hover:text-gray-900'
          }`}
        >
          <FolderPlus size={16} className="inline mr-2" />
          Categories
        </button>
      </div>

      {/* Templates Tab */}
      {activeTab === 'templates' && (
        <div className="space-y-3">
          <div className="flex justify-between items-center">
            <p className="text-sm text-gray-500">
              {templates.length} template{templates.length !== 1 ? 's' : ''}
            </p>
            <button
              onClick={onAddChore}
              className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition-colors"
            >
              <Plus size={16} />
              Add Template
            </button>
          </div>

          {/* Templates by Category */}
          {categories.map((cat) => {
            const catTemplates = templatesByCategory[cat.id] || [];
            if (catTemplates.length === 0) return null;

            return (
              <div
                key={cat.id}
                className="bg-white rounded-xl border border-gray-100 overflow-hidden"
              >
                <button
                  onClick={() => toggleCategory(cat.id)}
                  className="w-full p-3 flex items-center gap-3 hover:bg-gray-50 transition-colors"
                >
                  <div
                    className="w-8 h-8 rounded-lg flex items-center justify-center text-white text-sm font-medium"
                    style={{ backgroundColor: cat.color || '#8b5cf6' }}
                  >
                    {cat.name.charAt(0)}
                  </div>
                  <div className="flex-1 text-left">
                    <p className="font-medium text-gray-900">{cat.name}</p>
                    <p className="text-xs text-gray-500">{catTemplates.length} templates</p>
                  </div>
                  {expandedCategories.has(cat.id) ? (
                    <ChevronUp size={20} className="text-gray-400" />
                  ) : (
                    <ChevronDown size={20} className="text-gray-400" />
                  )}
                </button>

                {expandedCategories.has(cat.id) && (
                  <div className="border-t border-gray-100 divide-y divide-gray-50">
                    {catTemplates.map((template) => (
                      <TemplateRow
                        key={template.id}
                        template={template}
                        onEdit={() => setEditingTemplate(template)}
                        onDelete={() => setDeleteConfirm({ type: 'template', id: template.id })}
                      />
                    ))}
                  </div>
                )}
              </div>
            );
          })}

          {/* Uncategorized Templates */}
          {uncategorizedTemplates.length > 0 && (
            <div className="bg-white rounded-xl border border-gray-100 overflow-hidden">
              <button
                onClick={() => toggleCategory(null)}
                className="w-full p-3 flex items-center gap-3 hover:bg-gray-50 transition-colors"
              >
                <div className="w-8 h-8 rounded-lg bg-gray-300 flex items-center justify-center text-gray-600 text-sm font-medium">
                  ?
                </div>
                <div className="flex-1 text-left">
                  <p className="font-medium text-gray-900">Uncategorized</p>
                  <p className="text-xs text-gray-500">{uncategorizedTemplates.length} templates</p>
                </div>
                {expandedCategories.has(null) ? (
                  <ChevronUp size={20} className="text-gray-400" />
                ) : (
                  <ChevronDown size={20} className="text-gray-400" />
                )}
              </button>

              {expandedCategories.has(null) && (
                <div className="border-t border-gray-100 divide-y divide-gray-50">
                  {uncategorizedTemplates.map((template) => (
                    <TemplateRow
                      key={template.id}
                      template={template}
                      onEdit={() => setEditingTemplate(template)}
                      onDelete={() => setDeleteConfirm({ type: 'template', id: template.id })}
                    />
                  ))}
                </div>
              )}
            </div>
          )}

          {templates.length === 0 && (
            <div className="bg-white rounded-xl p-8 text-center text-gray-500 border border-gray-100">
              <FileText size={48} className="mx-auto mb-3 opacity-30" />
              <p>No templates yet</p>
              <button
                onClick={onAddChore}
                className="mt-3 text-purple-600 hover:text-purple-700 text-sm font-medium"
              >
                Create your first template
              </button>
            </div>
          )}
        </div>
      )}

      {/* Categories Tab */}
      {activeTab === 'categories' && (
        <div className="space-y-3">
          <div className="flex justify-between items-center">
            <p className="text-sm text-gray-500">
              {categories.length} categor{categories.length !== 1 ? 'ies' : 'y'}
            </p>
            <button
              onClick={onAddCategory}
              className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition-colors"
            >
              <Plus size={16} />
              Add Category
            </button>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {categories.map((cat) => (
              <div
                key={cat.id}
                className="bg-white rounded-xl border border-gray-100 p-4 flex items-center gap-3"
              >
                <div
                  className="w-10 h-10 rounded-lg flex items-center justify-center text-white font-medium"
                  style={{ backgroundColor: cat.color || '#8b5cf6' }}
                >
                  {cat.icon || cat.name.charAt(0)}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="font-medium text-gray-900 truncate">{cat.name}</p>
                  <p className="text-xs text-gray-500">
                    {templatesByCategory[cat.id]?.length || 0} templates
                  </p>
                </div>
                <div className="flex gap-1">
                  <button
                    onClick={() => setEditingCategory(cat)}
                    className="p-2 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
                  >
                    <Pencil size={16} />
                  </button>
                  <button
                    onClick={() => setDeleteConfirm({ type: 'category', id: cat.id })}
                    className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                  >
                    <Trash2 size={16} />
                  </button>
                </div>
              </div>
            ))}
          </div>

          {categories.length === 0 && (
            <div className="bg-white rounded-xl p-8 text-center text-gray-500 border border-gray-100">
              <FolderPlus size={48} className="mx-auto mb-3 opacity-30" />
              <p>No categories yet</p>
              <button
                onClick={onAddCategory}
                className="mt-3 text-purple-600 hover:text-purple-700 text-sm font-medium"
              >
                Create your first category
              </button>
            </div>
          )}
        </div>
      )}

      {/* Edit Template Modal */}
      {editingTemplate && (
        <EditTemplateModal
          template={editingTemplate}
          categories={categories}
          onClose={() => setEditingTemplate(null)}
          onSave={(updates) => handleUpdateTemplate(editingTemplate.id, updates)}
        />
      )}

      {/* Edit Category Modal */}
      {editingCategory && (
        <EditCategoryModal
          category={editingCategory}
          onClose={() => setEditingCategory(null)}
          onSave={(updates) => handleUpdateCategory(editingCategory.id, updates)}
        />
      )}

      {/* Delete Confirmation Modal */}
      {deleteConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
            <h3 className="text-lg font-semibold text-gray-900 mb-2">Confirm Delete</h3>
            <p className="text-gray-600 mb-4">
              {deleteConfirm.type === 'template'
                ? 'Are you sure you want to delete this template? This cannot be undone.'
                : 'Are you sure you want to delete this category? Templates using this category will become uncategorized.'}
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setDeleteConfirm(null)}
                className="flex-1 py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={() =>
                  deleteConfirm.type === 'template'
                    ? handleDeleteTemplate(deleteConfirm.id)
                    : handleDeleteCategory(deleteConfirm.id)
                }
                className="flex-1 py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Template Row Component
function TemplateRow({
  template,
  onEdit,
  onDelete,
}: {
  template: ChoreTemplate;
  onEdit: () => void;
  onDelete: () => void;
}) {
  return (
    <div className="p-3 flex items-center gap-3 hover:bg-gray-50">
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2">
          <p className="font-medium text-gray-900 truncate">{template.title}</p>
          {template.isSystem && (
            <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">System</span>
          )}
        </div>
        <div className="flex items-center gap-2 mt-1">
          <span
            className={`px-2 py-0.5 rounded text-xs font-medium ${DIFFICULTY_COLORS[template.difficulty]}`}
          >
            {template.difficulty}
          </span>
          <span className="text-xs text-gray-500">{template.defaultPoints} pts</span>
          {template.estimatedMinutes && (
            <span className="text-xs text-gray-500">{template.estimatedMinutes} min</span>
          )}
        </div>
      </div>
      <div className="flex gap-1">
        <button
          onClick={onEdit}
          className="p-2 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
        >
          <Pencil size={16} />
        </button>
        <button
          onClick={onDelete}
          className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
        >
          <Trash2 size={16} />
        </button>
      </div>
    </div>
  );
}

// Edit Template Modal
function EditTemplateModal({
  template,
  categories,
  onClose,
  onSave,
}: {
  template: ChoreTemplate;
  categories: ChoreCategory[];
  onClose: () => void;
  onSave: (updates: Partial<ChoreTemplate>) => void;
}) {
  const [title, setTitle] = useState(template.title);
  const [description, setDescription] = useState(template.description || '');
  const [categoryId, setCategoryId] = useState<number | null>(template.categoryId);
  const [difficulty, setDifficulty] = useState(template.difficulty);
  const [defaultPoints, setDefaultPoints] = useState(template.defaultPoints);
  const [estimatedMinutes, setEstimatedMinutes] = useState(template.estimatedMinutes || '');
  const [requirePhoto, setRequirePhoto] = useState(template.requirePhoto);
  const [requireApproval, setRequireApproval] = useState(template.requireApproval);
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    setSaving(true);
    await onSave({
      title,
      description: description || null,
      categoryId,
      difficulty,
      defaultPoints,
      estimatedMinutes: estimatedMinutes ? Number(estimatedMinutes) : null,
      requirePhoto,
      requireApproval,
    });
    setSaving(false);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-900">Edit Template</h3>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
            <X size={20} />
          </button>
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              rows={2}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select
              value={categoryId || ''}
              onChange={(e) => setCategoryId(e.target.value ? Number(e.target.value) : null)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            >
              <option value="">No Category</option>
              {categories.map((cat) => (
                <option key={cat.id} value={cat.id}>
                  {cat.name}
                </option>
              ))}
            </select>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Difficulty</label>
              <select
                value={difficulty}
                onChange={(e) => setDifficulty(e.target.value as any)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              >
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Points</label>
              <input
                type="number"
                value={defaultPoints}
                onChange={(e) => setDefaultPoints(Number(e.target.value))}
                min={1}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Estimated Minutes (optional)
            </label>
            <input
              type="number"
              value={estimatedMinutes}
              onChange={(e) => setEstimatedMinutes(e.target.value)}
              min={1}
              placeholder="e.g. 15"
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>

          <div className="space-y-2">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={requirePhoto}
                onChange={(e) => setRequirePhoto(e.target.checked)}
                className="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
              />
              <span className="text-sm text-gray-700">Require photo when completing</span>
            </label>
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={requireApproval}
                onChange={(e) => setRequireApproval(e.target.checked)}
                className="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
              />
              <span className="text-sm text-gray-700">Require admin approval</span>
            </label>
          </div>
        </div>

        <div className="flex gap-3 mt-6">
          <button
            onClick={onClose}
            className="flex-1 py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            disabled={saving || !title.trim()}
            className="flex-1 py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            {saving ? <Loader2 size={16} className="animate-spin" /> : <Check size={16} />}
            Save
          </button>
        </div>
      </div>
    </div>
  );
}

// Edit Category Modal
function EditCategoryModal({
  category,
  onClose,
  onSave,
}: {
  category: ChoreCategory;
  onClose: () => void;
  onSave: (updates: Partial<ChoreCategory>) => void;
}) {
  const [name, setName] = useState(category.name);
  const [color, setColor] = useState(category.color || '#8b5cf6');
  const [icon, setIcon] = useState(category.icon || '');
  const [saving, setSaving] = useState(false);

  const colors = [
    '#ef4444',
    '#f97316',
    '#f59e0b',
    '#eab308',
    '#84cc16',
    '#22c55e',
    '#10b981',
    '#14b8a6',
    '#06b6d4',
    '#0ea5e9',
    '#3b82f6',
    '#6366f1',
    '#8b5cf6',
    '#a855f7',
    '#d946ef',
    '#ec4899',
    '#f43f5e',
  ];

  const handleSave = async () => {
    setSaving(true);
    await onSave({ name, color, icon: icon || null });
    setSaving(false);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl p-6 max-w-md w-full">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-900">Edit Category</h3>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
            <X size={20} />
          </button>
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Icon (emoji or letter)
            </label>
            <input
              type="text"
              value={icon}
              onChange={(e) => setIcon(e.target.value)}
              maxLength={2}
              placeholder="ðŸ "
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Color</label>
            <div className="flex flex-wrap gap-2">
              {colors.map((c) => (
                <button
                  key={c}
                  onClick={() => setColor(c)}
                  className={`w-8 h-8 rounded-lg transition-transform ${
                    color === c ? 'ring-2 ring-offset-2 ring-gray-400 scale-110' : ''
                  }`}
                  style={{ backgroundColor: c }}
                />
              ))}
            </div>
          </div>

          {/* Preview */}
          <div className="pt-2">
            <label className="block text-sm font-medium text-gray-700 mb-2">Preview</label>
            <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
              <div
                className="w-10 h-10 rounded-lg flex items-center justify-center text-white font-medium"
                style={{ backgroundColor: color }}
              >
                {icon || name.charAt(0)}
              </div>
              <span className="font-medium text-gray-900">{name || 'Category Name'}</span>
            </div>
          </div>
        </div>

        <div className="flex gap-3 mt-6">
          <button
            onClick={onClose}
            className="flex-1 py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            disabled={saving || !name.trim()}
            className="flex-1 py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            {saving ? <Loader2 size={16} className="animate-spin" /> : <Check size={16} />}
            Save
          </button>
        </div>
      </div>
    </div>
  );
}
